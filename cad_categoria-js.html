<!DOCTYPE html>

<script>
    let Categoria;
    var dadosct;
    let CampoCategoria = document.getElementById("input_cad_categoria_servico");
    let CampoListaCategoria = document.getElementById("select_categoria");
    //let CampoListaCategoria = document.querySelector('select_categoria')

    document.addEventListener("DOMContentLoaded", function() {

        document.getElementById("btn_salvar_categoria").addEventListener("click", Bnt_Salvar_categoria);
        document.getElementById("btn_fechar").addEventListener("click", Fechar);
        document.getElementById("searchInput").addEventListener("input", btnInput);
        document.getElementById("searchResults").addEventListener("click", btnExcluirEditar);


        // document.getElementById("sim").addEventListener("click", () => {
        //     if (Confirmado())

        //         google.script.run.withSuccessHandler(Retorno)
        //         .SalvarCategoria(Categoria);

        //     function Retorno(r) {

        //         Gravando.style.visibility = 'hidden';
        //         Progresso.style.visibility = 'hidden';
        //         CaixaConfirmacao.style.display = "none";
        //         var m = r;
        //         caixaMsgbox(m);
        //         document.getElementById("input_cad_categoria_servico").value = "";

        //     }
        // });


        document.getElementById("select_categoria").addEventListener("change", Pesquisar);

        function Pesquisar() {

            let nomeCategoria = CampoListaCategoria.value;

            google.script.run.withSuccessHandler(Carregar).PesquisarCategoria(nomeCategoria);

        }

        function Carregar(r) {

            if (r != "CATEGORIA NÃO ENCONTRADA!") {

                CampoCategoria.value = r[0];
                M.updateTextFields();


            } else {

                var m = r;
                caixaMsgbox(m);

            }

        }
        //--------------------------------------------------------------------
        document.getElementById("btnEditar").addEventListener("click", EditarCategoria);

        function EditarCategoria() {

            let nomeCategoria = CampoListaCategoria.value;
            let Categoria = CampoCategoria.value;

            nomeCategoria = nomeCategoria.trim();
            Categoria = Categoria.trim();


            if (nomeCategoria == "" || nomeCategoria == "Escolha uma Categoria") {
                var m = "PRECISA SELECIONAR CATEGORIA NA LISTA!";
                caixaMsgbox(m);
                return
            }

            if (nomeCategoria == "" || Categoria == "") {
                var m = "PRECISA PREENCHER TODOS OS CAMPOS!";
                caixaMsgbox(m);
                return;
            }

            var Dados = {
                nomeCategoria: nomeCategoria,
                Categoria: Categoria,

            };

            google.script.run.withSuccessHandler(Retorno).EditarCategoria(Dados);

            function Retorno(r) {

                var m = r;
                caixaMsgbox(m);

                if (r != "CATEGORIA NÃO ENCONTRADA!") {
                    Limpar();
                }

            }

        }
        //---------------------------------------------------------------------        
        //-------------------------------------------------------------------

        //-------------------------------------------------------------
    })

    //------------------------------------------------------------------------
    var Confirm = new Mensagem();

    function Mensagem() {

        this.Executar = function(dados, e) {
            let menssagem
            CaixaMsg.style.display = "block";

            TituloMsg.innerHTML = "AVISO";
            CorpoMsg.innerHTML = "DESEJA REALMENTE EXCLUIR?";

            let BtnNao = '<button class = "btn btn-outline-dark" onclick = "Confirm.Nao()"  style = "cursor:pointer;border-radius: 5px" ><b><font   size = "4">Não</font></b></button>';
            let BtnSim = '<button class = "btn btn-outline-danger" onclick = "Confirm.Sim()" style = "cursor:pointer;border-radius: 5px;text-align: center  " ><b><font  size = "4">Sim</font></b></button>';

            RodapeMsg.innerHTML = BtnSim + BtnNao;
            this.Sim = function() {

                // let nomeCategoria = CampoListaCategoria.value;

                // if (nomeCategoria == "" || nomeCategoria == "Escolha uma Categoria") {
                //     CorpoMsg.innerHTML = "CANCELADO. CAMPO LISTA NÃO PODE SER VAZIO!";
                //     RodapeMsg.innerHTML = BtnFechar;
                //     return;
                // }



                menssagem = ExcluirCategoria(dados, e); // excluo do banco de dados

            }
            return menssagem
        }

        this.Nao = function() {
            Fechar();
        }



    }
    //---------------------------------------------------------------
    function ExcluirCategoria(dados, e) {

        let idcategoria = dados[1]


        google.script.run.withSuccessHandler(Excluir).ExcluirCategoria(idcategoria);

        let m

        function Excluir(r) {
            m = r;
            if (r == "EXCLUIDA COM SUCESSO!") {
                //  AtualizaCategorias();
                caixaMsgbox(m);
                Limpar(dados, e);
            } else {
                m = r;
                CorpoMsg.style.fontSize = "1em"
                caixaMsgbox(m);
            }

        }

    }
    //--------------------------------------------------------------------------------
    function Limpar(dados, e) {

        dadosct.map((el, index) => {

            if (el[0] === parseInt(dados[1])) {
                e.target.parentNode.parentNode.remove() // excluo do html
                dadosct.splice(index, 1); // excluo do array

            }
        })

        let CampoListaCategoria = document.getElementById("select_categoria");


        // var option = CampoListaCategoria.options[CampoListaCategoria.selectedIndex]
        var option = CampoListaCategoria.options[1]

        CampoListaCategoria.remove(CampoListaCategoria.selectedIndex);
        // let Select = document.getElementById("sel");
        // M.FormSelect.init(Select);
        //  M.FormSelect.updateTextFields(CampoListaCategoria);

    }
    //-------------------------------------------
    function CaixaAlta(e) {
        var ss = e.target.selectionStart;
        var se = e.target.selectionEnd;
        e.target.value = e.target.value.toUpperCase();
        e.target.selectionStart = ss;
        e.target.selectionEnd = se;
    }
    //----------------------------------------------------------------------------

    //---------------------------------------------------------------
    function Bnt_Salvar_categoria() {
        Categoria = document.getElementById("input_cad_categoria_servico").value;

        Categoria = Categoria.trim();

        if (Categoria == "") {
            var m = "FAVOR PREENCHER CAMPO CATEGORIA!";
            caixaMsgbox(m);
            return false;
        }
        Confirmacao();


    }
    //-------------------------------------------------------------------
    function AtualizaCategorias() {
        CampoListaCategoria.options.length = -1;
    }
    //----------------------------------------------------------------------
    function setDataForSearchCt() {
        google.script.run.withSuccessHandler(function(options) {

            dadosct = options.slice()

        }).getDataForSearchCt()
    }
    setDataForSearchCt() // carrega a variavel dadosct que sao todas as categorias do banco
        //-----------------------------------------------------------------------------------
    function search() {

        // dadosct.sort()
        var searchInput = document.getElementById("searchInput").value.toString().toLowerCase().trim()

        var searchWords = searchInput.split(/\s+/)

        var searchColumnar = [0, 1]

        // and or
        var resultsArray = searchInput === "" ? [] : dadosct.filter(function(r) {


            return searchWords.every(function(wordCd) {
                return searchColumnar.some(function(colIndexCd) {
                    return r[colIndexCd].toString().toLowerCase().indexOf(wordCd) !== -1
                })
            })
        })

        var searchResultsBox = document.getElementById("searchResults")
        var templateBox = document.getElementById("rowTemplate")
        var template = templateBox.content

        searchResultsBox.innerHTML = ""

        resultsArray.forEach(function(r) {


            var tr = template.cloneNode(true)
            var idColuna = tr.querySelector(".se-IDt")
            var categoriaColuna = tr.querySelector(".se-categoria")

            idColuna.textContent = r[0]
            categoriaColuna.textContent = r[1]

            searchResultsBox.appendChild(tr)

        })

    }
    //---------------------------------------------------------------------------------------------
    const btnInput = (e) => {

            if (e.target.matches("#searchInput")) {

                search()

            }


        }
        //-----------------------------------------------------------------------  
    const btnExcluirEditar = (e) => {

        if (e.target.matches(".btn")) {

            let dados = e.target.parentNode.parentNode.textContent
            dados = dados.split(/\s{2,}/) // expressão regular para criar um array dos dados

            if (e.target.textContent == "Editar") {

            } else { // se nao for pra editar entao so pode ser para excluir

                Confirm.Executar(dados, e)







            }
            // excluir(e)

        }


    }

    function excluir(e) {
        //var categoria = e.target.firstChild.textContent
        var categoria = e.target.parentNode.parentNode.textContent
        categoria = categoria.split(/\s{2,}/)
        var total = categoria.length
            // var categoria = e.target.childNodes[0].textContent
        alert("cliquei no botao " + categoria[2] + ", " + categoria[3])
            // firstChild.textContent
    }
</script>